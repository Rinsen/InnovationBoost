"use strict";angular.module("isteven-multi-select",["ng"]).directive("istevenMultiSelect",["$sce","$timeout","$templateCache",function(u,y,e){return{restrict:"AE",scope:{inputModel:"=",outputModel:"=",isDisabled:"=",onClear:"&",onClose:"&",onSearchChange:"&",onItemClick:"&",onOpen:"&",onReset:"&",onSelectAll:"&",onSelectNone:"&",translation:"="},templateUrl:"isteven-multi-select.htm",link:function(c,o,g){c.backUp=[],c.varButtonLabel="",c.spacingProperty="",c.indexProperty="",c.orientationH=!1,c.orientationV=!0,c.filteredModel=[],c.inputLabel={labelFilter:""},c.tabIndex=0,c.lang={},c.helperStatus={all:!0,none:!0,reset:!0,filter:!0};var f=0,l=[],h=0,i="",a=[],n=0,b=null;c.clearClicked=function(e){c.inputLabel.labelFilter="",c.updateFilter(),c.select("clear",e)},c.numberToArray=function(e){return new Array(e)},c.searchChanged=function(){if(c.inputLabel.labelFilter.length<n&&0<c.inputLabel.labelFilter.length)return!1;c.updateFilter()},c.updateFilter=function(){c.filteredModel=[];var e=0;if(void 0===c.inputModel)return!1;for(e=c.inputModel.length-1;0<=e;e--){void 0!==c.inputModel[e][g.groupProperty]&&!1===c.inputModel[e][g.groupProperty]&&c.filteredModel.push(c.inputModel[e]);var t=!1;if(void 0===c.inputModel[e][g.groupProperty]){if(void 0!==g.searchProperty&&""!==g.searchProperty){for(var r in c.inputModel[e])if("boolean"!=typeof c.inputModel[e][r]&&0<=String(c.inputModel[e][r]).toUpperCase().indexOf(c.inputLabel.labelFilter.toUpperCase())&&-1<g.searchProperty.indexOf(r)){t=!0;break}}else for(var r in c.inputModel[e])if("boolean"!=typeof c.inputModel[e][r]&&0<=String(c.inputModel[e][r]).toUpperCase().indexOf(c.inputLabel.labelFilter.toUpperCase())){t=!0;break}!0===t&&c.filteredModel.push(c.inputModel[e])}void 0!==c.inputModel[e][g.groupProperty]&&!0===c.inputModel[e][g.groupProperty]&&(void 0!==c.filteredModel[c.filteredModel.length-1][g.groupProperty]&&!1===c.filteredModel[c.filteredModel.length-1][g.groupProperty]?c.filteredModel.pop():c.filteredModel.push(c.inputModel[e]))}c.filteredModel.reverse(),y(function(){if(c.getFormElements(),c.inputLabel.labelFilter.length>n){var l=[];angular.forEach(c.filteredModel,function(e,t){if(void 0!==e&&void 0===e[g.groupProperty]){var r=angular.copy(e),n=l.push(r);delete l[n-1][c.indexProperty],delete l[n-1][c.spacingProperty]}}),c.onSearchChange({data:{keyword:c.inputLabel.labelFilter,result:l}})}},0)},c.getFormElements=function(){a=[];var e=[],t=[],r=[],n=[];c.helperStatus.all||c.helperStatus.none||c.helperStatus.reset?(e=o.children().children().next().children().children()[0].getElementsByTagName("button"),c.helperStatus.filter&&(t=o.children().children().next().children().children().next()[0].getElementsByTagName("input"),n=o.children().children().next().children().children().next()[0].getElementsByTagName("button"))):c.helperStatus.filter&&(t=o.children().children().next().children().children()[0].getElementsByTagName("input"),n=o.children().children().next().children().children()[0].getElementsByTagName("button")),r=c.helperStatus.all||c.helperStatus.none||c.helperStatus.reset||c.helperStatus.filter?o.children().children().next().children().next()[0].getElementsByTagName("input"):o.children().children().next()[0].getElementsByTagName("input");for(var l=0;l<e.length;l++)a.push(e[l]);for(l=0;l<t.length;l++)a.push(t[l]);for(l=0;l<n.length;l++)a.push(n[l]);for(l=0;l<r.length;l++)a.push(r[l])},c.isGroupMarker=function(e,t){return void 0!==e[g.groupProperty]&&e[g.groupProperty]===t},c.removeGroupEndMarker=function(e){return void 0===e[g.groupProperty]||!1!==e[g.groupProperty]},c.syncItems=function(e,t,r){if(t.preventDefault(),t.stopPropagation(),void 0!==g.disableProperty&&!0===e[g.disableProperty])return!1;if(void 0!==g.isDisabled&&!0===c.isDisabled)return!1;if(void 0!==e[g.groupProperty]&&!1===e[g.groupProperty])return!1;var n=c.filteredModel.indexOf(e);if(void 0!==e[g.groupProperty]&&!0===e[g.groupProperty]){if(void 0!==g.selectionMode&&"SINGLE"===g.selectionMode.toUpperCase())return!1;var l,o,i=0,a=c.filteredModel.length-1,d=[],s=0;for(l=n;l<c.filteredModel.length&&!(0===s&&n<l);l++)if(void 0!==c.filteredModel[l][g.groupProperty]&&!0===c.filteredModel[l][g.groupProperty])0===d.length&&(i=l+1),s+=1;else if(void 0!==c.filteredModel[l][g.groupProperty]&&!1===c.filteredModel[l][g.groupProperty]){if(--s,0<d.length&&0===s){var u=!0;for(a=l,o=0;o<d.length;o++)if(void 0!==d[o][c.tickProperty]&&!1===d[o][c.tickProperty]){u=!1;break}if(!0===u)for(o=i;o<=a;o++)void 0===c.filteredModel[o][g.groupProperty]&&(void 0===g.disableProperty?(c.filteredModel[o][c.tickProperty]=!1,p=c.filteredModel[o][c.indexProperty],c.inputModel[p][c.tickProperty]=!1):!0!==c.filteredModel[o][g.disableProperty]&&(c.filteredModel[o][c.tickProperty]=!1,p=c.filteredModel[o][c.indexProperty],c.inputModel[p][c.tickProperty]=!1));else for(o=i;o<=a;o++)void 0===c.filteredModel[o][g.groupProperty]&&(void 0===g.disableProperty?(c.filteredModel[o][c.tickProperty]=!0,p=c.filteredModel[o][c.indexProperty],c.inputModel[p][c.tickProperty]=!0):!0!==c.filteredModel[o][g.disableProperty]&&(c.filteredModel[o][c.tickProperty]=!0,p=c.filteredModel[o][c.indexProperty],c.inputModel[p][c.tickProperty]=!0))}}else d.push(c.filteredModel[l])}else{if(void 0!==g.selectionMode&&"SINGLE"===g.selectionMode.toUpperCase()){for(l=0;l<c.filteredModel.length;l++)c.filteredModel[l][c.tickProperty]=!1;for(l=0;l<c.inputModel.length;l++)c.inputModel[l][c.tickProperty]=!1;c.filteredModel[n][c.tickProperty]=!0}else c.filteredModel[n][c.tickProperty]=!c.filteredModel[n][c.tickProperty];var p=c.filteredModel[n][c.indexProperty];c.inputModel[p][c.tickProperty]=c.filteredModel[n][c.tickProperty]}null!==(b=angular.copy(e))&&y(function(){delete b[c.indexProperty],delete b[c.spacingProperty],c.onItemClick({data:b}),b=null},0),c.refreshOutputModel(),c.refreshButton(),f=c.tabIndex,c.tabIndex=r+h,t.target.focus(),c.removeFocusStyle(f),c.setFocusStyle(c.tabIndex),void 0!==g.selectionMode&&"SINGLE"===g.selectionMode.toUpperCase()&&c.toggleCheckboxes(t)},c.refreshOutputModel=function(){c.outputModel=[];var n=[],l={};void 0!==g.outputProperties?(n=g.outputProperties.split(" "),angular.forEach(c.inputModel,function(e,t){if(void 0!==e&&void 0===e[g.groupProperty]&&!0===e[c.tickProperty]){l={},angular.forEach(e,function(e,t){-1<n.indexOf(t)&&(l[t]=e)});var r=c.outputModel.push(l);delete c.outputModel[r-1][c.indexProperty],delete c.outputModel[r-1][c.spacingProperty]}})):angular.forEach(c.inputModel,function(e,t){if(void 0!==e&&void 0===e[g.groupProperty]&&!0===e[c.tickProperty]){var r=angular.copy(e),n=c.outputModel.push(r);delete c.outputModel[n-1][c.indexProperty],delete c.outputModel[n-1][c.spacingProperty]}})},c.refreshButton=function(){c.varButtonLabel="";var r=0;if(0===c.outputModel.length)c.varButtonLabel=c.lang.nothingSelected;else{var n=c.outputModel.length;void 0!==g.maxLabels&&""!==g.maxLabels&&(n=g.maxLabels),c.outputModel.length>n?c.more=!0:c.more=!1,angular.forEach(c.inputModel,function(e,t){void 0!==e&&!0===e[g.tickProperty]&&(r<n&&(c.varButtonLabel+=(0<c.varButtonLabel.length?'</div>, <div class="buttonLabel">':'<div class="buttonLabel">')+c.writeLabel(e,"buttonLabel")),r++)}),!0===c.more&&(0<n&&(c.varButtonLabel+=", ... "),c.varButtonLabel+="("+c.outputModel.length+")")}c.varButtonLabel=u.trustAsHtml(c.varButtonLabel+'<span class="caret"></span>')},c.itemIsDisabled=function(e){return void 0!==g.disableProperty&&!0===e[g.disableProperty]||!0===c.isDisabled},c.writeLabel=function(r,e){var t=g[e].split(" "),n="";return angular.forEach(t,function(e,t){r[e]&&(n+="&nbsp;"+e.split(".").reduce(function(e,t){return e[t]},r))}),"BUTTONLABEL"===e.toUpperCase()?n:u.trustAsHtml(n)},c.toggleCheckboxes=function(e){var t=o.children()[0];if(angular.element(document).off("click",c.externalClickListener),angular.element(document).off("keydown",c.keyboardListener),angular.element(i).hasClass("show"))angular.element(i).removeClass("show"),angular.element(t).removeClass("buttonClicked"),angular.element(document).off("click",c.externalClickListener),angular.element(document).off("keydown",c.keyboardListener),c.removeFocusStyle(c.tabIndex),void 0!==a[c.tabIndex]&&a[c.tabIndex].blur(),y(function(){c.onClose()},0),o.children().children()[0].focus();else{c.inputLabel.labelFilter="",c.updateFilter(),l=[],h=0,angular.element(i).addClass("show"),angular.element(t).addClass("buttonClicked"),angular.element(document).on("click",c.externalClickListener),angular.element(document).on("keydown",c.keyboardListener),c.getFormElements(),c.tabIndex=0;var r=angular.element(o[0].querySelector(".helperContainer"))[0];if(void 0!==r){for(var n=0;n<r.getElementsByTagName("BUTTON").length;n++)l[n]=r.getElementsByTagName("BUTTON")[n];h=l.length+r.getElementsByTagName("INPUT").length}o[0].querySelector(".inputFilter")?(o[0].querySelector(".inputFilter").focus(),c.tabIndex=c.tabIndex+h-2,angular.element(o).children()[0].blur()):c.isDisabled||(c.tabIndex=c.tabIndex+h,0<c.inputModel.length&&(a[c.tabIndex].focus(),c.setFocusStyle(c.tabIndex),angular.element(o).children()[0].blur())),c.onOpen()}},c.externalClickListener=function(e){for(var t=o.find(e.target.tagName),r=0;r<t.length;r++)if(e.target==t[r])return;angular.element(i.previousSibling).removeClass("buttonClicked"),angular.element(i).removeClass("show"),angular.element(document).off("click",c.externalClickListener),angular.element(document).off("keydown",c.keyboardListener),y(function(){c.onClose()},0),o.children().children()[0].focus()},c.select=function(e,t){var r=l.indexOf(t.target);switch(c.tabIndex=r,e.toUpperCase()){case"ALL":angular.forEach(c.filteredModel,function(e,t){void 0!==e&&!0!==e[g.disableProperty]&&void 0===e[g.groupProperty]&&(e[c.tickProperty]=!0)}),c.refreshOutputModel(),c.refreshButton(),c.onSelectAll();break;case"NONE":angular.forEach(c.filteredModel,function(e,t){void 0!==e&&!0!==e[g.disableProperty]&&void 0===e[g.groupProperty]&&(e[c.tickProperty]=!1)}),c.refreshOutputModel(),c.refreshButton(),c.onSelectNone();break;case"RESET":angular.forEach(c.filteredModel,function(e,t){if(void 0===e[g.groupProperty]&&void 0!==e&&!0!==e[g.disableProperty]){var r=e[c.indexProperty];e[c.tickProperty]=c.backUp[r][c.tickProperty]}}),c.refreshOutputModel(),c.refreshButton(),c.onReset();break;case"CLEAR":c.tabIndex=c.tabIndex+1,c.onClear();break;case"FILTER":c.tabIndex=l.length-1}},c.prepareGrouping=function(){var r=0;angular.forEach(c.filteredModel,function(e,t){e[c.spacingProperty]=r,!0===e[g.groupProperty]?r+=2:!1===e[g.groupProperty]&&(r-=2)})},c.prepareIndex=function(){var r=0;angular.forEach(c.filteredModel,function(e,t){e[c.indexProperty]=r,r++})},c.keyboardListener=function(e){var t=e.keyCode?e.keyCode:e.which,r=!1;if(27===t)e.preventDefault(),e.stopPropagation(),c.toggleCheckboxes(e);else if(40===t||39===t||!e.shiftKey&&9==t)for(r=!0,f=c.tabIndex,c.tabIndex++,c.tabIndex>a.length-1&&(c.tabIndex=0,f=a.length-1);!0===a[c.tabIndex].disabled&&(c.tabIndex++,c.tabIndex>a.length-1&&(c.tabIndex=0),c.tabIndex!==f););else if(38===t||37===t||e.shiftKey&&9==t)for(r=!0,f=c.tabIndex,c.tabIndex--,c.tabIndex<0&&(c.tabIndex=a.length-1,f=0);!0===a[c.tabIndex].disabled&&(c.tabIndex--,c.tabIndex!==f);)c.tabIndex<0&&(c.tabIndex=a.length-1);!0===r&&(e.preventDefault(),a[c.tabIndex].focus(),"CHECKBOX"===document.activeElement.type.toUpperCase()?(c.setFocusStyle(c.tabIndex),c.removeFocusStyle(f)):(c.removeFocusStyle(f),c.removeFocusStyle(h),c.removeFocusStyle(a.length-1)));r=!1},c.setFocusStyle=function(e){angular.element(a[e]).parent().parent().parent().addClass("multiSelectFocus")},c.removeFocusStyle=function(e){angular.element(a[e]).parent().parent().parent().removeClass("multiSelectFocus")},c.groupProperty=g.groupProperty,c.tickProperty=g.tickProperty,c.directiveId=g.directiveId;var e=function(e){for(var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz",r="",n=0;n<e;n++)r+=t.charAt(Math.floor(Math.random()*t.length));return r}(5);if(c.indexProperty="idx_"+e,c.spacingProperty="spc_"+e,void 0!==g.orientation&&("HORIZONTAL"===g.orientation.toUpperCase()?(c.orientationH=!0,c.orientationV=!1):(c.orientationH=!1,c.orientationV=!0)),i=o.children().children().next()[0],void 0!==g.maxHeight){var t=o.children().children().children()[0];angular.element(t).attr("style","height:"+g.maxHeight+"; overflow-y:scroll;")}for(var r in c.helperStatus)c.helperStatus.hasOwnProperty(r)&&void 0!==g.helperElements&&-1===g.helperElements.toUpperCase().indexOf(r.toUpperCase())&&(c.helperStatus[r]=!1);void 0!==g.selectionMode&&"SINGLE"===g.selectionMode.toUpperCase()&&(c.helperStatus.all=!1,c.helperStatus.none=!1),c.icon={},c.icon.selectAll="&#10003;",c.icon.selectNone="&times;",c.icon.reset="&#8630;",c.icon.tickMark="&#10003;",void 0!==g.translation?(c.lang.selectAll=u.trustAsHtml(c.icon.selectAll+"&nbsp;&nbsp;"+c.translation.selectAll),c.lang.selectNone=u.trustAsHtml(c.icon.selectNone+"&nbsp;&nbsp;"+c.translation.selectNone),c.lang.reset=u.trustAsHtml(c.icon.reset+"&nbsp;&nbsp;"+c.translation.reset),c.lang.search=c.translation.search,c.lang.nothingSelected=u.trustAsHtml(c.translation.nothingSelected)):(c.lang.selectAll=u.trustAsHtml(c.icon.selectAll+"&nbsp;&nbsp;Select All"),c.lang.selectNone=u.trustAsHtml(c.icon.selectNone+"&nbsp;&nbsp;Select None"),c.lang.reset=u.trustAsHtml(c.icon.reset+"&nbsp;&nbsp;Reset"),c.lang.search="Search...",c.lang.nothingSelected="None Selected"),c.icon.tickMark=u.trustAsHtml(c.icon.tickMark),void 0!==g.MinSearchLength&&0<parseInt(g.MinSearchLength)&&(n=Math.floor(parseInt(g.MinSearchLength))),c.$watch("inputModel",function(e){e&&(c.refreshOutputModel(),c.refreshButton())},!0),c.$watch("inputModel",function(e){e&&(c.backUp=angular.copy(c.inputModel),c.updateFilter(),c.prepareGrouping(),c.prepareIndex(),c.refreshOutputModel(),c.refreshButton())}),c.$watch("isDisabled",function(e){c.isDisabled=e});function d(e){c.$apply(function(){c.scrolled=!1})}angular.element(document).bind("touchstart",d);function s(e){c.$apply(function(){c.scrolled=!0})}angular.element(document).bind("touchmove",s),c.$on("$destroy",function(){angular.element(document).unbind("touchstart",d),angular.element(document).unbind("touchmove",s)})}}}]).run(["$templateCache",function(e){e.put("isteven-multi-select.htm",'<span class="multiSelect inlineBlock"><button id="{{directiveId}}" type="button"ng-click="toggleCheckboxes( $event ); refreshSelectedItems(); refreshButton(); prepareGrouping; prepareIndex();"ng-bind-html="varButtonLabel"ng-disabled="disable-button"></button><div class="checkboxLayer"><div class="helperContainer" ng-if="helperStatus.filter || helperStatus.all || helperStatus.none || helperStatus.reset "><div class="line" ng-if="helperStatus.all || helperStatus.none || helperStatus.reset "><button type="button" class="helperButton"ng-disabled="isDisabled"ng-if="helperStatus.all"ng-click="select( \'all\', $event );"ng-bind-html="lang.selectAll"></button><button type="button" class="helperButton"ng-disabled="isDisabled"ng-if="helperStatus.none"ng-click="select( \'none\', $event );"ng-bind-html="lang.selectNone"></button><button type="button" class="helperButton reset"ng-disabled="isDisabled"ng-if="helperStatus.reset"ng-click="select( \'reset\', $event );"ng-bind-html="lang.reset"></button></div><div class="line" style="position:relative" ng-if="helperStatus.filter"><input placeholder="{{lang.search}}" type="text"ng-click="select( \'filter\', $event )" ng-model="inputLabel.labelFilter" ng-change="searchChanged()" class="inputFilter"/><button type="button" class="clearButton" ng-click="clearClicked( $event )" >×</button> </div> </div> <div class="checkBoxContainer"><div ng-repeat="item in filteredModel | filter:removeGroupEndMarker" class="multiSelectItem"ng-class="{selected: item[ tickProperty ], horizontal: orientationH, vertical: orientationV, multiSelectGroup:item[ groupProperty ], disabled:itemIsDisabled( item )}"ng-click="syncItems( item, $event, $index );" ng-mouseleave="removeFocusStyle( tabIndex );"> <div class="acol" ng-if="item[ spacingProperty ] > 0" ng-repeat="i in numberToArray( item[ spacingProperty ] ) track by $index"></div>  <div class="acol"><label><input class="checkbox focusable" type="checkbox" ng-disabled="itemIsDisabled( item )" ng-checked="item[ tickProperty ]" ng-click="syncItems( item, $event, $index )" /><span ng-class="{disabled:itemIsDisabled( item )}" ng-bind-html="writeLabel( item, \'itemLabel\' )"></span></label></div><span class="tickMark" ng-if="item[ groupProperty ] !== true && item[ tickProperty ] === true" ng-bind-html="icon.tickMark"></span></div></div></div></span>')}]);